{% extends 'core/base.html' %} {% block content %}
<div class="d-flex justify-content-center mt-5">
    <div class="col-md-7 mb-1 mt-1 text-white text-center ">
        <div class="container">
            <h1 class="jumbotron-heading">Patient records</h1>
            <p class="lead">On this page you can work with patient data</p>
        </div>
    </div>
</div>


<div class="container mt-3">

    <div class="card">

        <div class="card-body">
            <div class="tab-content">
                <div id="dia" class="tab-pane fade show active " role="tabpanel">
                    <table id="patient_table" class="table table-striped table-bordered " cellspacing="0" style="width:100%">
                        <thead>
                            <a id="patient_btn" href="" data-toggle="modal" data-target="#add_patient" class="btn btn-primary btn-xs pull-left add-elem">Add new record</a>
                            <tr>
                                <th>Card number</th>
                                <th>FIO</th>
                                <th>Birthday</th>
                                <th>Sex</th>
                                <th>Adress</th>
                                <th>Phone</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in records %}
                            <tr>
                                <td>{{ record.NumberRecord }}</td>
                                <td>{{ record.FirstLastMiddle }}</td>
                                <td>{{ record.Birthday }}</td>
                                <td>{{ record.Sex }}</td>
                                <td>{{ record.Adress }}</td>
                                <td>{{ record.Phone }}</td>
                                <td class="td-actions text-right">
                                    <button type="button" rel="tooltip" class="btn btn-success btn-just-icon btn-sm" data-original-title="" title="">
                                    <i class="material-icons">edit</i>
                                </button>
                                    <button type="button" rel="tooltip" data-id="{{ record.id }}" data-db="record" class="btn btn-danger btn-just-icon btn-sm delete mr-3" data-original-title="" title="">
                                    <i class="material-icons">close</i>
                                </button>
                                    <button type="button" rel="tooltip" class="btn btn-info btn-just-icon btn-sm" data-original-title="" title="">
                                    <i class="material-icons">person</i>
                                    <div class="ripple-container"></div></button>
                                </td>
                            </tr>

                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<form class="add-form" data-db="records" method="POST">
    <div id="add_patient" class="modal" tabindex="0" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create diagnos</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
                </div>
                <div class="modal-body">
                    {% csrf_token %} {{ formRecords }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </div>
        </div>
    </div>
</form>



<script>
    $(document).ready(function() {
        $(".nav-tabs a").click(function() {
            $(this).tab('show');
        });

        $('#patient_table').DataTable({
            "aLengthMenu": [
                [5, 10, 25, -1],
                [5, 10, 25, "All"]
            ]
        });

        $("[data-toggle=tooltip]").tooltip();


        $(document).delegate('.delete', 'click', function() {
            var id = $(this).data('id');
            var row = $(this).closest("tr").get(0);
            url = "{% url 'delete_patient_records' %}";
            table_name = "#patient_table";

            if (url != "") {
                $.post(url, {
                    id: id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                }, function(data) {
                    alert(data);
                    if (data == "0") {
                        var oTable = $(table_name).dataTable();
                        oTable.fnDeleteRow(oTable.fnGetPosition(row));

                    } else {
                        alert("Строка не удалена");
                    }
                });
            } else {
                alert("Error: url");
            }

        });

        $('.add-form').submit(function(e) {
            e.preventDefault();
            var db = $(this).data('db');
            url = "{% url 'add_patient_records' %}";
            table_name = "#patient_table";

            Card_number = $(this)[0][2]["value"];
            FIO = $(this)[0][3]["value"];
            Birthday = $(this)[0][4]["value"];
            Sex = $(this)[0][5]["value"];
            Adress = $(this)[0][6]["value"];
            Phone = $(this)[0][7]["value"];

            datain = $(this).serialize();
            if (url != "") {
                $.post(url, datain, function(data) {
                    //alert(data);
                    if (data == "-1") {
                        alert("Строка не добавлена");
                    } else if (data == "-2") {
                        alert("Строка уже существует");
                    } else {
                        var rData = [
                            Card_number,
                            FIO,
                            Birthday,
                            Sex,
                            Adress,
                            Phone,
                            '<div class="container text-right">' +
                            '<button type="button" rel="tooltip" class="btn btn-success btn-just-icon btn-sm pr-2" data-original-title="" title=""> ' +
                            '<i class="material-icons">edit</i>' +
                            '</button> ' +
                            '<button type="button" rel="tooltip" data-id="' + "" + '" data-db="' + "" + '" class="btn btn-danger btn-just-icon btn-sm delete " data-original-title="" title="">' +
                            '<i class="material-icons">close</i>' +
                            '</button>' +
                            '</div>'
                        ];

                        $(table_name).DataTable().row.add(rData).draw(false);

                        $('#add_patient').modal('hide');
                        $('.add-form').trigger('reset');
                    }
                });
            } else {
                alert("Error: url");
            }
        });

    });

    $(document).ready(function() {

    });
</script>


<style>
    body.modal-open {
        overflow: auto;
    }
    
    body.modal-open[style] {
        padding-right: 0px !important;
    }
    
    .modal::-webkit-scrollbar {
        width: 0 !important;
        /*removes the scrollbar but still scrollable*/
        /* reference: http://stackoverflow.com/a/26500272/2259400 */
    }
    
    table {
        width: 100%;
    }
    
    #patient_table_filter {
        float: right;
    }
    
    #patient_table_paginate {
        float: right;
    }
    
    #patient_table_length {
        float: left;
    }
    
    #patient_table_length label {
        display: flex;
        flex-direction: row;
        justify-content: center;
        margin-top: 15px;
    }
    
    #patient_table_length select {
        margin-left: 5px;
        margin-right: 5px;
    }
    
    #patient_table label {
        display: flex;
        flex-direction: row;
        justify-content: center;
        margin-top: 15px;
    }
    
    #patient_table input {
        margin-left: 10px;
    }
    
    .add-elem {
        margin-top: 10px;
    }
    
    .back-to-top {
        cursor: pointer;
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: none;
    }
</style>


{% endblock %}