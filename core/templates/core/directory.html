{% extends 'core/base.html' %}

{% block content %}
<div class="d-flex justify-content-center mt-5">
    <div class="col-md-7 mb-1 mt-1 text-white text-center ">
        <div class="container">
            <h1 class="jumbotron-heading">Directory</h1>
            <p class="lead">On this page, you can work with data: diagnoses, symptoms, syndromes.</p>
        </div>
    </div>
</div>


<div class="container mt-3">
    
    <div class="card">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs">
            <li class="nav-item">
              <a class="nav-link text-dark " href="#syn">Syndromes</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-dark active" href="#dia">Diagnoses</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-dark " href="#sym">Symptoms</a>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content">
            <div id="syn" class="tab-pane fade" role="tabpanel">
                <h3>HOME</h3>
                <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
            </div>
                  
            <div id="dia" class="tab-pane fade show active " role="tabpanel">
                <table id="diagnos_table" class="table table-striped table-bordered " cellspacing="0" style="width:100%">
                    <thead>
                        <a id="diagnos_btn" href="" data-toggle="modal" data-target="#add_diagnos" class="btn btn-primary btn-xs pull-left add-elem">Add new diagnos</a>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for diagnos in diagnoses %}
                        <tr>
                            <td>{{ diagnos.Name }}</td>
                            <td>{{ diagnos.Description }}</td>
                            <td class="td-actions text-right">
                                <button type="button" rel="tooltip" class="btn btn-success btn-just-icon btn-sm" data-original-title="" title="">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button type="button" rel="tooltip" data-id="{{ diagnos.id }}" data-db="diagnos" class="btn btn-danger btn-just-icon btn-sm delete mr-3" data-original-title="" title="">
                                    <i class="material-icons">close</i>
                                </button>
                            </td>
                        </tr>
    
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div id="sym" class="tab-pane fade" role="tabpanel">
                <table id="symptom_table" class="table table-striped table-bordered " cellspacing="0" style="width:100%">
                    <thead>
                        <a id="symptom_btn" href="" data-toggle="modal" data-target="#add_symptom" class="btn btn-primary btn-xs pull-left add-elem">Add new symptom</a>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for symptom in symptomes %}
                        <tr>
                            <td>{{ symptom.Name }}</td>
                            <td>{{ symptom.Description }}</td>
                            <td class="td-actions text-right">
                                <button type="button" rel="tooltip" class="btn btn-success btn-just-icon btn-sm" data-original-title="" title="">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button type="button" rel="tooltip" data-id="{{ symptom.id }}" data-db="symptom" class="btn btn-danger btn-just-icon btn-sm delete mr-3" data-original-title="" title="">
                                    <i class="material-icons">close</i>
                                </button>
                            </td>
                        </tr>
    
                        {% endfor %}
                    </tbody>
                </table>
            </div>
          </div>
        </div>
      </div>
</div>

<form class="add-form" data-db="diagnos" method="POST">
<div id="add_diagnos" class="modal" tabindex="0" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create diagnos</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {% csrf_token %}
          {{ formDiagnos }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Create</button>
         </div>
      </div>
    </div>
</div>
</form>

<form class="add-form" data-db="symptom" method="POST">
    <div id="add_symptom" class="modal" tabindex="0" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Create symptom</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              {% csrf_token %}
              {{ formSymptom }}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Create</button>
             </div>
          </div>
        </div>
    </div>
    </form>






<script>
    $(document).ready(function(){
        $(".nav-tabs a").click(function(){
            $(this).tab('show');
        });

        $('#diagnos_table').DataTable({     
            "aLengthMenu": [[5, 10, 25, -1], [5, 10, 25, "All"]]
        });
        $('#symptom_table').DataTable({     
            "aLengthMenu": [[5, 10, 25, -1], [5, 10, 25, "All"]]
        });
        $("[data-toggle=tooltip]").tooltip();


        $(document).delegate('.delete', 'click', function() { 
            var id = $(this).data('id');
            var db = $(this).data('db');
            var row = $(this).closest("tr").get(0);
            
            if(db == "diagnos"){
                url = "{% url 'delete_diagnos' %}";
                table_name= "#diagnos_table";
            } else if(db == "symptom"){
                url = "{% url 'delete_symptom' %}";
                table_name= "#symptom_table";
            } else{
                url = "";
                table_name="";
            }
            if(url !=""){
                $.post(url, {id:id, 'csrfmiddlewaretoken': '{{ csrf_token }}'}, function(data) {
                    if(data == "0"){
                        var oTable = $(table_name).dataTable();
                        oTable.fnDeleteRow(oTable.fnGetPosition(row));
                        
                    }
                    else {
                        alert("Строка не удалена");
                    }
                }); 
            } else{
                alert("Error: url");
            }

        });

        $('.add-form').submit(function(e) {
            e.preventDefault();
            var db = $(this).data('db');
            if(db == "diagnos"){
                url = "{% url 'add_diagnos' %}";
                table_name= "#diagnos_table";
            } else if(db == "symptom"){
                url = "{% url 'add_symptom' %}";
                table_name= "#symptom_table";
            } else{
                url = "";
                table_name="";
            }
            name = $(this)[0][2]["value"];
            description = $(this)[0][3]["value"];
            datain = $(this).serialize();
            if(url !=""){
                $.post(url, datain, function(data) {
                    if(data == "-1"){
                        alert("Строка не добавлена");
                    }else if(data=="-2"){
                        alert("Строка уже существует");
                    }else {
                        var rData = [
                            name,
                            description,
                            '<div class="container text-right">'+
                            '<button type="button" rel="tooltip" class="btn btn-success btn-just-icon btn-sm pr-2" data-original-title="" title=""> '+
                               '<i class="material-icons">edit</i>'+
                            '</button> '+
                            '<button type="button" rel="tooltip" data-id="'+data+'" data-db="'+db+'" class="btn btn-danger btn-just-icon btn-sm delete " data-original-title="" title="">'+
                                '<i class="material-icons">close</i>'+
                            '</button>'+
                            '</div>'
                        ];
                        $(table_name).DataTable().row.add(rData).draw(false);

                        $('#add_symptom').modal('hide');
                        $('#add_diagnos').modal('hide');
                        $('.add-form').trigger('reset');
                    }
                }); 
            } else{
                alert("Error: url");
            }
        });

    });

    $(document).ready(function() {
        
    });
    
</script>

<style>
body.modal-open {
    overflow: auto;
}
body.modal-open[style] {
    padding-right: 0px !important;
}

.modal::-webkit-scrollbar {
    width: 0 !important; /*removes the scrollbar but still scrollable*/
    /* reference: http://stackoverflow.com/a/26500272/2259400 */
}

table{
    width:100%;
}
#diagnos_table_filter, #symptom_table_filter{
    float: right;
}
#diagnos_table_paginate, #symptom_table_paginate{
    float: right;
}
#diagnos_table_length, #symptom_table_length{
    float: left;
}
#diagnos_table_length label, #symptom_table_length label{
    display: flex;
    flex-direction: row;
    justify-content: center;
    margin-top: 15px;
}

#diagnos_table_length select, #symptom_table_length select{
   margin-left: 5px;
   margin-right: 5px;
}

#diagnos_table_filter label, #symptom_table_filter label{
    display: flex;
    flex-direction: row;
    justify-content: center;
    margin-top: 15px;
}

#diagnos_table_filter input, #symptom_table_filter input{
    margin-left: 10px;
}

.add-elem{
    margin-top: 10px;
}

.back-to-top {
    cursor: pointer;
    position: fixed;
    bottom: 20px;
    right: 20px;
    display:none;
}

</style>


{% endblock %}